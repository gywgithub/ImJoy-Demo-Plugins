<docs lang="markdown">
Demo plugin to demonstrate how to plot charts in ImJoy. For this, some data is generated
in a Python plugin and displayed in a separate window. We demonstrate two different options

1. First, you can send the data to a window plugin. This plugin then used one of several
JavaScript libraries to plot your data. We provide simple implementations for these libraries
    * [C3](https://c3js.org/)
    * [Chart.js](https://www.chartjs.org/docs/latest/)
    * [Plotly](https://plot.ly/javascript/)

2. You can directly create an image (`.png`) in the Python plugin. This image is then send
to a window plugin and displayed there. Such an image is not restricted to simple charts,
and can thus also contain more complex data which can not be send by the plugin communicatino protocols.


</docs>

<config lang="json">
{
  "name": "Charts PyWorker",
  "type": "native-python",
  "version": "0.1.0",
  "api_version": "0.1.2",
  "description": "PyWorker plugin sending data to window plugin to plot.",
  "tags": [],
  "ui": [
        "Try differen JS chart libraries.",
        "<hr>",
        "Type: {id:'chart_type', type: 'choose', options: ['Plotly','C3','Chart.js','.png'], placeholder: 'Plotly'}",
        "Chart title:{id:'chart_txt',type:'string',placeholder:'Custom text'}",
        "# of data points : {id:'n_points', type: 'number', min: 0, placeholder:20}"
        ],
  "inputs": null,
  "outputs": null,
  "flags": [],
  "icon": "swap_horiz",
  "env": null,
  "requirements": ["numpy", "matplotlib"],
  "dependencies": ["oeway/ImJoy-Demo-Plugins:Charts JS window"]
}
</config>

<script lang="python">

import matplotlib as mpl
mpl.use('Agg')

import matplotlib.pyplot as plt
plt.ioff()
import numpy as np
import base64
import asyncio

class ImJoyPlugin():
    def setup(self):
        self.window = None

    async def run(self, my):

        api.showStatus('[DEMO] Python worker to plot charts')
        print(my.config.chart_type)

        # Create damped cosine and dictionary for window
        x_values = np.arange(0.0, 5.0, 5.0/my.config.n_points)
        y_values = np.exp(-x_values) * np.cos(2*np.pi*x_values)


        ### Create data depending on chart type

        # Create png file
        if my.config.chart_type == '.png':
            # Plot curve and save as png
            fig1, ax = plt.subplots(num='Example plot')
            plt.plot(x_values, y_values)
            name_plot = 'test.png'
            plt.savefig(name_plot,dpi=200)

            with open(name_plot, 'rb') as f:
                data = f.read()
                result = base64.b64encode(data).decode('ascii')
                imgurl = 'data:image/png;base64,' + result
                data = {"src": imgurl}

                data_plot = {
                    'name':'Plot charts: show png',
                    'type':'imjoy/image',
                    'w':12, 'h':15,
                    'data':data}

        # Use JavaScript chart libraries
        else:
            data = {'x': x_values.tolist(),
                    'y': y_values.tolist(),
                    'type': my.config.chart_type,
                    'chart_txt':my.config.chart_txt}

            data_plot = {
                    'name':'Plot charts - with JavaScripts',
                    'type':'Charts JS window',
                    'w':12, 'h':15,
                    'data':data}



        # Plot results

        ## Check if window was defined
        if self.window is None:
            self.window = await api.createWindow(data_plot)
            print(f'Window created')

        else:
            print(f'Update window.')
            try:
                await self.window.run(data=data)
            except:
                self.window = await api.createWindow(data_plot)
                print(f'Could not print to old window. New window created.')

api.export(ImJoyPlugin())
</script>
