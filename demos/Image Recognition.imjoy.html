
<docs lang="markdown">
A pretrained MobileNet image classifier built with Tensorflow.js.

This plugin is ported from: [mobilenet example for Tensorflow.js](https://github.com/tensorflow/tfjs-models/tree/master/mobilenet).
</docs>

<config lang="json">
{
  "name": "Image Recognition",
  "mode": "window",
  "tags": [],
  "ui": "A pretrained MobileNet image classifier built with Tensorflow.js",
  "version": "0.1.0",
  "api_version": "0.1.1",
  "description": "A pretrained MobileNet image classifier built with Tensorflow.js",
  "icon": "extension",
  "inputs": null,
  "outputs": null,
  "env": "",
  "requirements": [
    "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.11.7",
    "https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@0.1.1"
  ],
  "dependencies": [],
  "defaults": {"w": 10, "h": 10}
}
</config>

<script lang="javascript">
class ImJoyPlugin {
  async setup() {
    // bind predict() to the button
    const predictBtn = document.getElementById('predict-btn');
    predictBtn.onclick = ()=>{
      this.predict()
    }
    // hide the predict button for now
    predictBtn.style.display = "none"

    // Display image when a file is selected.
    const fileInput = document.getElementById("file-input");
    const targetImg = document.getElementById("target");
    fileInput.onchange = ()=>{
        var fr=new FileReader();
        // when image is loaded, set the src of the image where you want to display it
        fr.onload = function(e) { targetImg.src = this.result; };
        // fill fr with image data    
        fr.readAsDataURL(fileInput.files[0]);
    }
    // Load the model.
    const statusElement = document.getElementById("status");
    statusElement.innerHTML = 'Loading pretrained model...';
    this.model = await mobilenet.load();
    statusElement.innerHTML = 'Model loaded, please open an image (.png/.jpg) and click `Predict`.!';
    // display the predict button
    predictBtn.style.display = "inline";
  }

  async predict(){
    const img = document.getElementById('target');
    // Classify the image.
    const predictions = await this.model.classify(img)
    // Output the result
    console.log('Predictions: ', predictions);
    const result_string = `Top-1 Prediction: ${predictions[0].className} (${Math.round(predictions[0].probability*100)}%)`;
    document.getElementById("status").innerHTML = result_string
    api.alert(result_string)
  }

  run(my) {
    
  }
}

api.export(new ImJoyPlugin())
</script>

<window lang="html">
  <div>
    <p id="status"></p>
    <input class="form-input" id="file-input" type="file"/>
    <button class="form-input btn" id="predict-btn">Predict</button>
    <img id="target" crossorigin="" src="https://static.imjoy.io/img/cat.jpg"></img>
  </div>
</window>

