<docs lang="markdown">
[TODO: write documentation for this plugin.]
</docs>

<config lang="json">
{
  "name": "PythonServer",
  "type": "native-python",
  "version": "0.1.0",
  "api_version": "0.1.2",
  "description": "[TODO: describe this plugin with one sentence.]",
  "tags": [],
  "ui": "",
  "inputs": null,
  "outputs": null,
  "flags": [],
  "icon": "extension",
  "env": "",
  "requirements": [],
  "dependencies": ["gywgithub/ImJoy-Demo-Plugins:ResultWindow"]
}
</config>

<script lang="python">
import numpy as np
import random
import time
import os
from multiprocessing import Queue, Pool, Process
import threading
os.chdir("./faceid")
from face import facefile_detection, facefile_compare
# from HTTPServer import http_server_start, http_server_stop
http_server = "http://facefiles.sg-ai.com/"
# http_server = "http://192.168.199.107:8000/"

class ImJoyPlugin():
    def setup(self):
        print('setup in python')

    def run(self):
        print('starting server ... ')

    # 人脸检测
    async def predict(self, list):
        output_dir = "data/result/"
        res = []
        print("list:", list)

        for item in list:
            print(item)
            result_file = facefile_detection(image_name=item.filename, image_path=item.path, output_dir=output_dir)
            print("result_file:", result_file)
            if result_file:
                res.append({'IOU': random.random(), 'fileName': item.filename, 'predictUrl': http_server + result_file,
                            'message': ''})
            else:
                res.append({'IOU': random.random(), 'fileName': item.filename, 'predictUrl': http_server + result_file,
                            'message': '不存在人脸'})

        print(res)
        return res

    # 1:1 人脸核验
    def predictII(self, args):
        print(args)
        data_queue = Queue(maxsize=10)
        p = Process(target=facefile_compare, args=(data_queue, args[0]["path"]))
        p.daemon = True
        p.start()

        first_res = data_queue.get()
        print("first_res:", first_res)
        win = api.createWindow({
            'name': 'ResultWindow',
            'type': 'ResultWindow',
            'w': 10, 'h': 10,
            'data': {'ID': first_res[0], 'flag': first_res[1], 'time': first_res[2]}
        })

        while True:
            try:
                result = data_queue.get(timeout=10)
                print("result:", result)
                win.run({'function': 'FunctionII', 'data': {'ID': result[0], 'flag': result[1], 'time': result[2]}})
            except:
                break
        return True

        
    # 1:n人脸识别 导入底库
    async def importNegative (self, args):
        print('importNegative: ', args)
        time.sleep(2)
        return 'ok'

    # 1:n人脸识别 预测
    async def predictIII (self, args):
        print(args)
        win = await api.createWindow({
            'name': 'ResultWindow',
            'type': 'ResultWindow',
            'w':10, 'h':10,
            'data':{'fileName': '', 'flag': '是', 'time': '0s', 'message': ''}
        })
        i = 1
        while i <= 1000:
            win.run({'function': 'FunctionIII', 'data':{'fileName': 'cat.jpg', 'flag': '是', 'time': '0.01s', 'message': '没有人脸'}})
            i += 1
        return '1'



    # 关键点检测
    async def predictIV (self, args):
        print(args)
        win = await api.createWindow({
            'name': 'ResultWindow',
            'type': 'ResultWindow',
            'w':10, 'h':10,
            'data':{'fileName': '', 'keyPoint': ''}
        })
        i = 1
        while i <= 1000:
            win.run({'function': 'FunctionIV', 'data':{'fileName': 'cat.jpg', 'keyPoint': '[{x: 1, y: 1}, {x2: 2, y2: 2}]'}})
            i += 1
        return '1'

    # 活体检测
    async def predictV (self, args):
        print(args)
        win = await api.createWindow({
            'name': 'ResultWindow',
            'type': 'ResultWindow',
            'w':10, 'h':10,
            'data':{'fileName': '', 'flag': ''}
        })
        i = 1
        while i <= 1000:
            win.run({'function': 'FunctionV', 'data':{'fileName': 'cat.jpg', 'flag': '否'}})
            i += 1
        return '1'

    # 图像质量检测
    async def predictVI (self, args):
        print(args)
        win = await api.createWindow({
            'name': 'ResultWindow',
            'type': 'ResultWindow',
            'w':10, 'h':10,
            'data':{'fileName': '', 'message': ''}
        })
        i = 1
        while i <= 25:
            win.run({'function': 'FunctionVI', 'data':{'fileName': 'cat.jpg', 'message': '图像模糊,详细描述...'}})
            i += 1
        return '1'

api.export(ImJoyPlugin())
</script>
